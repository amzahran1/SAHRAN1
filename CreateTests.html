<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Create Test - Ahmed Omar Math Professor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        .navbar {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .navbar .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .navbar .nav-links button {
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s;
        }

        .navbar .nav-links button:hover {
            color: #f1c40f;
        }

        .navbar .nav-links .dropdown {
            position: relative;
            display: inline-block;
        }

        .navbar .nav-links .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 4px;
            min-width: 120px;
        }

        .navbar .nav-links .dropdown-content button {
            color: #2c3e50;
            padding: 8px 12px;
            display: block;
            text-align: left;
            white-space: nowrap;
            width: 100%;
        }

        .navbar .nav-links .dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .navbar .nav-links .dropdown:hover .dropdown-content {
            display: block;
        }

        .navbar .nav-links .nav-button {
            background-color: #f1c40f;
            color: #2c3e50;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .navbar .nav-links .nav-button:hover {
            background-color: #d4ac0d;
        }

        .quiz-section {
            padding: 50px 20px;
            background-color: #f5f5f5;
            display: none;
        }

        .quiz-section.active {
            display: block;
        }

        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .quiz-container h1, .quiz-container h2, .quiz-container h3 {
            color: #2c3e50;
        }

        .question-input, .quiz-question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        textarea, input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .edit-questions-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }

        .edit-questions-btn:hover {
            background-color: #2980b9;
        }

        .answer-options-styled {
            margin-top: 15px;
        }

        .answer-option-container {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 4px;
            background-color: #f5f5f5;
            text-align: left;
        }

        .option-letter {
            font-weight: bold;
            margin-right: 10px;
        }

        .navigation-buttons {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .image-container {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin: 10px 0;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .question-image, .answer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .quiz-display-section {
            margin-top: 30px;
            display: none;
        }

        .quiz-display-section.active {
            display: block;
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }

        .quiz-question {
            display: none;
        }

        .quiz-question.active {
            display: block;
        }

        .question-type-selector {
            margin-bottom: 15px;
        }

        .short-answer-input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .hidden {
            display: none;
        }

        .grid-in-section {
            margin-top: 15px;
            text-align: center;
        }

        .grid-in-answer-box {
            position: relative;
            width: 150px;
            height: 60px;
            border: 2px solid #000;
            border-radius: 8px;
            background-color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .grid-in-line {
            position: absolute;
            width: 90%;
            height: 2px;
            background-color: #000;
            bottom: 10px;
        }

        .grid-in-input {
            position: absolute;
            width: 90%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 16px;
            outline: none;
            top: 50%;
            transform: translateY(-50%);
        }

        .grid-in-input::placeholder {
            color: #999;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            cursor: pointer;
        }

        .remove-question {
            background-color: #e74c3c;
            color: white;
            margin-top: 10px;
        }

        .remove-question:hover {
            background-color: #c0392b;
        }

        .timer-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .timer-progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
        }

        .timer-progress-bar {
            height: 100%;
            background-color: #f1c40f;
            border-radius: 5px;
            width: 100%;
            transition: width 1s linear;
        }

        .test-report {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .report-summary {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
        }

        .score-card {
            text-align: center;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #f1c40f;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            color: #2c3e50;
            font-weight: bold;
        }

        .detailed-results {
            margin-top: 30px;
        }

        .result-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            position: relative;
        }

        .answer-comparison {
            display: flex;
            margin-top: 10px;
        }

        .user-answer, .correct-answer {
            flex: 1;
            padding: 10px;
        }

        .result-icon {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
        }

        .break-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }

        .break-screen.active {
            display: flex;
        }

        .break-screen h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
    </style>
    <script>
        MathJax = {
            tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
        };
    </script>
    <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="navbar">
        <div class="nav-links">
            <div class="dropdown">
                <button type="button">Create Test ▼</button>
                <div class="dropdown-content">
                    <button onclick="showQuiz('act-i')" type="button">ACT I</button>
                    <button onclick="showQuiz('act-ii')" type="button">ACT II</button>
                    <button onclick="showQuiz('est-i')" type="button">EST I</button>
                    <button onclick="showQuiz('est-ii')" type="button">EST II</button>
                    <button onclick="showQuiz('digital-sat')" type="button">Digital SAT</button>
                    <button onclick="showQuiz('univ-course')" type="button">University Courses</button>
                </div>
            </div>
        </div>
    </div>
    <div class="quiz-section" id="quizSection">
        <div class="quiz-container">
            <div class="back-btn" onclick="hideQuiz()">← Back to Test Selection</div>
            <h1 id="quizTitle">Create Test</h1>
            <div id="quizBuilder">
                <label for="testTitle">Test Title:</label>
                <input id="testTitle" required type="text"/>
                <div class="section-config">
                    <h3>Section Configuration</h3>
                    <div>
                        <label for="section1Questions">Number of Questions (Section 1):</label>
                        <input id="section1Questions" min="1" required type="number" value="5"/>
                    </div>
                    <div>
                        <label for="section1Duration">Duration (Section 1, minutes):</label>
                        <input id="section1Duration" min="1" required type="number" value="30"/>
                    </div>
                    <div>
                        <label for="section2Questions">Number of Questions (Section 2):</label>
                        <input id="section2Questions" min="1" required type="number" value="5"/>
                    </div>
                    <div>
                        <label for="section2Duration">Duration (Section 2, minutes):</label>
                        <input id="section2Duration" min="1" required type="number" value="30"/>
                    </div>
                    <div>
                        <label for="breakDuration">Break Duration Between Sections (minutes):</label>
                        <input id="breakDuration" min="0" required type="number" value="10"/>
                    </div>
                    <div>
                        <label for="testType">Test Type:</label>
                        <select id="testType">
                            <option value="free">Free</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                </div>
                <div id="questionsContainer">
                    <div class="question-input" id="question-1">
                        <h3>Question 1 (Section 1)</h3>
                        <div class="question-type-selector">
                            <label>Question Type:</label>
                            <select class="question-type-select" id="questionType1">
                                <option value="multiple-choice">Multiple Choice</option>
                                <option value="short-answer">Short Answer (Fill in the blank)</option>
                                <option value="grid-in">Grid-In</option>
                            </select>
                        </div>
                        <label for="questionText1">Question Text:</label><br/>
                        <textarea id="questionText1" required rows="3"></textarea><br/><br/>
                        <label for="questionImage1">Question Image (optional):</label><br/>
                        <input accept="image/*" id="questionImage1" type="file"/><br/><br/>
                        <div class="multiple-choice-options" id="answerOptions1">
                            <h4>Answer Options:</h4>
                            <div class="answer-options-input">
                                <div>
                                    <label>
                                        <input name="correctAnswer1" type="radio" value="1"/>
                                        Option 1:
                                    </label>
                                    <input id="answer1_1" required type="text"/>
                                    <label for="answerImage1_1">Option 1 Image (optional):</label>
                                    <input accept="image/*" id="answerImage1_1" type="file"/>
                                </div>
                                <div>
                                    <label>
                                        <input checked name="correctAnswer1" type="radio" value="2"/>
                                        Option 2:
                                    </label>
                                    <input id="answer1_2" required type="text"/>
                                    <label for="answerImage1_2">Option 2 Image (optional):</label>
                                    <input accept="image/*" id="answerImage1_2" type="file"/>
                                </div>
                                <div>
                                    <label>
                                        <input name="correctAnswer1" type="radio" value="3"/>
                                        Option 3:
                                    </label>
                                    <input id="answer1_3" required type="text"/>
                                    <label for="answerImage1_3">Option 3 Image (optional):</label>
                                    <input accept="image/*" id="answerImage1_3" type="file"/>
                                </div>
                                <div>
                                    <label>
                                        <input name="correctAnswer1" type="radio" value="4"/>
                                        Option 4:
                                    </label>
                                    <input id="answer1_4" required type="text"/>
                                    <label for="answerImage1_4">Option 4 Image (optional):</label>
                                    <input accept="image/*" id="answerImage1_4" type="file"/>
                                </div>
                            </div>
                        </div>
                        <div class="short-answer-options hidden" id="shortAnswerOptions1">
                            <h4>Correct Answer:</h4>
                            <input id="correctShortAnswer1" placeholder="Enter the correct answer" type="text"/>
                            <p>Note: The answer will be case-insensitive and trimmed of whitespace for comparison.</p>
                        </div>
                        <div class="grid-in-options hidden" id="gridInOptions1">
                            <h4>Correct Answer:</h4>
                            <input id="correctGridInAnswer1" placeholder="Enter the correct answer" type="text"/>
                            <p>Note: The answer will be case-insensitive and trimmed of whitespace for comparison.</p>
                        </div>
                        <button class="remove-question" data-question-id="question-1" type="button">Remove Question</button>
                    </div>
                </div>
                <button id="addQuestionBtn">Add Question</button>
                <button id="saveTestBtn">Save Test</button>
                <button id="displayQuizBtn">Display Quiz</button>
            </div>
            <div class="quiz-display-section" id="quizDisplaySection">
                <div class="timer-container">
                    <h3>Time Remaining (Section <span id="currentSectionTimerLabel">1</span>): <span id="timerSection1">00:00</span></h3>
                    <div class="timer-progress">
                        <div class="timer-progress-bar" id="timerProgressBarSection1"></div>
                    </div>
                </div>
                <h2 id="currentSectionTitle">Preview Quiz - Section 1</h2>
                <div id="quizQuestions"></div>
                <div class="navigation-buttons">
                    <button disabled id="prevQuestion" type="button">Previous Question</button>
                    <span id="currentQuestionNumber">Question 1 of 1</span>
                    <button id="nextQuestion" type="button">Next Question</button>
                </div>
                <button class="submit-section1-btn hidden" id="submitSection1Btn" type="button">Submit Section 1</button>
                <button class="submit-section2-btn hidden" id="submitSection2Btn" type="button">Submit Section 2</button>
                <button class="edit-questions-btn hidden" id="editQuestionsBtn" type="button">Edit Test</button>
                <div class="results hidden" id="resultsSection1"></div>
                <div class="results hidden" id="resultsSection2"></div>
            </div>
        </div>
    </div>
    <div class="break-screen" id="breakScreen">
        <h2>Section Break</h2>
        <p>Time remaining: <span id="breakTimer">10:00</span></p>
    </div>
    <script>
        // Global variables
        let currentType = '';
        let questionCountSection1 = 0;
        let questionCountSection2 = 0;
        let currentSection = 1;
        let currentQuestionIndex = 0;
        let section1Timer, section2Timer, breakTimer;
        let section1Duration = 0;
        let section2Duration = 0;
        let breakDuration = 0;
        let testQuestions = [];
        let userAnswers = [];
        let editTestId = null;

        // Show quiz section with dynamic title
        function showQuiz(type) {
            currentType = type;
            document.getElementById('quizSection').classList.add('active');
            updateQuizTitle();
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const urlParams = new URLSearchParams(window.location.search);
            editTestId = urlParams.get('id');
            if (editTestId) {
                document.getElementById('quizTitle').textContent = 'Edit Test';
                loadTestForEdit(editTestId);
            }
        }

        function hideQuiz() {
            document.getElementById('quizSection').classList.remove('active');
            document.getElementById('quizDisplaySection').classList.remove('active');
            document.getElementById('quizBuilder').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            editTestId = null;
        }

        function updateQuizTitle() {
            const titles = {
                'act-i': 'Create ACT I Test',
                'act-ii': 'Create ACT II Test',
                'est-i': 'Create EST I Test',
                'est-ii': 'Create EST II Test',
                'digital-sat': 'Create Digital SAT Test',
                'univ-course': 'Create University Course Test'
            };
            if (!editTestId) {
                document.getElementById('quizTitle').textContent = titles[currentType] || 'Create Test';
            }
        }

        function loadTestForEdit(testId) {
            const savedTests = JSON.parse(localStorage.getItem('savedTests')) || {};
            const test = savedTests[testId];
            if (!test) return;

            document.getElementById('testTitle').value = test.data.title || 'Untitled Test';
            document.getElementById('section1Questions').value = test.data.sections[0].questions.length;
            document.getElementById('section1Duration').value = test.data.sections[0].duration;
            document.getElementById('section2Questions').value = test.data.sections[1].questions.length;
            document.getElementById('section2Duration').value = test.data.sections[1].duration;
            document.getElementById('breakDuration').value = test.data.breakDuration;
            document.getElementById('testType').value = test.data.isPaid ? 'paid' : 'free';

            document.getElementById('questionsContainer').innerHTML = '';
            test.data.sections.forEach((section, sectionIndex) => {
                section.questions.forEach((question, qIndex) => {
                    const totalIndex = sectionIndex === 0 ? qIndex + 1 : qIndex + 1 + test.data.sections[0].questions.length;
                    addQuestion(totalIndex, sectionIndex + 1, question);
                });
            });

            questionCountSection1 = test.data.sections[0].questions.length;
            questionCountSection2 = test.data.sections[1].questions.length;
        }

        // Add new question
        document.getElementById('addQuestionBtn').addEventListener('click', function () {
            const section1Questions = parseInt(document.getElementById('section1Questions').value);
            const section2Questions = parseInt(document.getElementById('section2Questions').value);
            const totalQuestions = section1Questions + section2Questions;

            const currentQuestions = document.querySelectorAll('.question-input').length;
            if (currentQuestions >= totalQuestions) {
                alert('You have reached the maximum number of questions for this test.');
                return;
            }

            const section = currentQuestions < section1Questions ? 1 : 2;
            const questionNum = currentQuestions + 1;
            addQuestion(questionNum, section);
        });

        function addQuestion(questionNum, section, questionData = null) {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-input';
            questionDiv.id = `question-${questionNum}`;

            const questionType = questionData ? questionData.type : 'multiple-choice';
            const questionText = questionData ? questionData.text : '';
            const questionImage = questionData ? questionData.image : '';
            const answers = questionData ? questionData.answers : ['', '', '', ''];
            const correctAnswer = questionData ? questionData.correctAnswer : '2';
            const correctShortAnswer = questionData ? questionData.correctAnswer : '';
            const correctGridInAnswer = questionData ? questionData.correctAnswer : '';

            questionDiv.innerHTML = `
                <h3>Question ${questionNum} (Section ${section})</h3>
                <div class="question-type-selector">
                    <label>Question Type:</label>
                    <select id="questionType${questionNum}" class="question-type-select">
                        <option value="multiple-choice" ${questionType === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option>
                        <option value="short-answer" ${questionType === 'short-answer' ? 'selected' : ''}>Short Answer (Fill in the blank)</option>
                        <option value="grid-in" ${questionType === 'grid-in' ? 'selected' : ''}>Grid-In</option>
                    </select>
                </div>
                <label for="questionText${questionNum}">Question Text:</label><br>
                <textarea id="questionText${questionNum}" rows="3" required>${questionText}</textarea><br><br>
                <label for="questionImage${questionNum}">Question Image (optional):</label><br>
                <input type="file" id="questionImage${questionNum}" accept="image/*"><br><br>
                <div id="answerOptions${questionNum}" class="multiple-choice-options ${questionType !== 'multiple-choice' ? 'hidden' : ''}">
                    <h4>Answer Options:</h4>
                    <div class="answer-options-input">
                        <div>
                            <label>
                                <input type="radio" name="correctAnswer${questionNum}" value="1" ${correctAnswer === '1' ? 'checked' : ''}>
                                Option 1:
                            </label>
                            <input type="text" id="answer${questionNum}_1" value="${answers[0]}" required>
                            <label for="answerImage${questionNum}_1">Option 1 Image (optional):</label>
                            <input type="file" id="answerImage${questionNum}_1" accept="image/*">
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="correctAnswer${questionNum}" value="2" ${correctAnswer === '2' ? 'checked' : ''}>
                                Option 2:
                            </label>
                            <input type="text" id="answer${questionNum}_2" value="${answers[1]}" required>
                            <label for="answerImage${questionNum}_2">Option 2 Image (optional):</label>
                            <input type="file" id="answerImage${questionNum}_2" accept="image/*">
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="correctAnswer${questionNum}" value="3" ${correctAnswer === '3' ? 'checked' : ''}>
                                Option 3:
                            </label>
                            <input type="text" id="answer${questionNum}_3" value="${answers[2]}" required>
                            <label for="answerImage${questionNum}_3">Option 3 Image (optional):</label>
                            <input type="file" id="answerImage${questionNum}_3" accept="image/*">
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="correctAnswer${questionNum}" value="4" ${correctAnswer === '4' ? 'checked' : ''}>
                                Option 4:
                            </label>
                            <input type="text" id="answer${questionNum}_4" value="${answers[3]}" required>
                            <label for="answerImage${questionNum}_4">Option 4 Image (optional):</label>
                            <input type="file" id="answerImage${questionNum}_4" accept="image/*">
                        </div>
                    </div>
                </div>
                <div id="shortAnswerOptions${questionNum}" class="short-answer-options ${questionType !== 'short-answer' ? 'hidden' : ''}">
                    <h4>Correct Answer:</h4>
                    <input type="text" id="correctShortAnswer${questionNum}" placeholder="Enter the correct answer" value="${correctShortAnswer}">
                    <p>Note: The answer will be case-insensitive and trimmed of whitespace for comparison.</p>
                </div>
                <div id="gridInOptions${questionNum}" class="grid-in-options ${questionType !== 'grid-in' ? 'hidden' : ''}">
                    <h4>Correct Answer:</h4>
                    <input type="text" id="correctGridInAnswer${questionNum}" placeholder="Enter the correct answer" value="${correctGridInAnswer}">
                    <p>Note: The answer will be case-insensitive and trimmed of whitespace for comparison.</p>
                </div>
                <button type="button" class="remove-question" data-question-id="question-${questionNum}">Remove Question</button>
            `;

            questionsContainer.appendChild(questionDiv);

            // Ensure question type selector works
            const questionTypeSelect = document.getElementById(`questionType${questionNum}`);
            questionTypeSelect.addEventListener('change', function () {
                const type = this.value;
                const answerOptions = document.getElementById(`answerOptions${questionNum}`);
                const shortAnswerOptions = document.getElementById(`shortAnswerOptions${questionNum}`);
                const gridInOptions = document.getElementById(`gridInOptions${questionNum}`);

                // Hide all options first
                answerOptions.classList.add('hidden');
                shortAnswerOptions.classList.add('hidden');
                gridInOptions.classList.add('hidden');

                // Show the selected option
                if (type === 'multiple-choice') {
                    answerOptions.classList.remove('hidden');
                } else if (type === 'short-answer') {
                    shortAnswerOptions.classList.remove('hidden');
                } else if (type === 'grid-in') {
                    gridInOptions.classList.remove('hidden');
                }
            });

            // Attach remove question event listener
            const removeButton = questionDiv.querySelector('.remove-question');
            removeButton.addEventListener('click', function () {
                const questionId = this.getAttribute('data-question-id');
                const questionElement = document.getElementById(questionId);
                if (questionElement) {
                    questionElement.remove();
                    updateQuestionNumbers();
                }
            });

            if (questionImage) {
                const imgPreview = document.createElement('img');
                imgPreview.src = questionImage;
                imgPreview.className = 'question-image';
                const imageInput = questionDiv.querySelector(`#questionImage${questionNum}`);
                imageInput.after(imgPreview);
                const label = imageInput.parentElement;
                label.innerHTML += ` <span>(Existing image loaded)</span>`;
            }
        }

        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-input');
            const section1Questions = parseInt(document.getElementById('section1Questions').value);
            
            // Update section counts
            questionCountSection1 = 0;
            questionCountSection2 = 0;

            questions.forEach((question, index) => {
                const questionNum = index + 1;
                const section = questionNum <= section1Questions ? 1 : 2;
                question.id = `question-${questionNum}`;
                question.querySelector('h3').textContent = `Question ${questionNum} (Section ${section})`;
                question.querySelector('.remove-question').setAttribute('data-question-id', `question-${questionNum}`);

                // Update section counts
                if (section === 1) {
                    questionCountSection1++;
                } else {
                    questionCountSection2++;
                }

                const oldNum = index + 2; // Adjust based on previous numbering
                ['questionType', 'questionText', 'questionImage', 'answerOptions', 'shortAnswerOptions', 'gridInOptions', 'correctShortAnswer', 'correctGridInAnswer'].forEach(field => {
                    const element = question.querySelector(`#${field}${oldNum}`);
                    if (element) {
                        element.id = `${field}${questionNum}`;
                    }
                });

                for (let i = 1; i <= 4; i++) {
                    const answerInput = question.querySelector(`#answer${oldNum}_${i}`);
                    const answerImageInput = question.querySelector(`#answerImage${oldNum}_${i}`);
                    const radio = question.querySelector(`input[name="correctAnswer${oldNum}"][value="${i}"]`);
                    if (answerInput) answerInput.id = `answer${questionNum}_${i}`;
                    if (answerImageInput) answerImageInput.id = `answerImage${questionNum}_${i}`;
                    if (radio) radio.name = `correctAnswer${questionNum}`;
                }
            });
        }

        // Save test
        document.getElementById('saveTestBtn').addEventListener('click', async function () {
            const testTitle = document.getElementById('testTitle').value.trim();
            if (!testTitle) {
                alert('Please enter a test title.');
                return;
            }

            const section1Questions = parseInt(document.getElementById('section1Questions').value);
            const section1Duration = parseInt(document.getElementById('section1Duration').value);
            const section2Questions = parseInt(document.getElementById('section2Questions').value);
            const section2Duration = parseInt(document.getElementById('section2Duration').value);
            const breakDuration = parseInt(document.getElementById('breakDuration').value);
            const testType = document.getElementById('testType').value;

            const questions = document.querySelectorAll('.question-input');
            if (questions.length !== (section1Questions + section2Questions)) {
                alert('Please add the correct number of questions for both sections.');
                return;
            }

            const testData = {
                title: testTitle,
                sections: [
                    { questions: [], duration: section1Duration },
                    { questions: [], duration: section2Duration }
                ],
                breakDuration: breakDuration,
                isPaid: testType === 'paid'
            };

            for (let index = 0; index < questions.length; index++) {
                const questionNum = index + 1;
                const section = questionNum <= section1Questions ? 0 : 1;
                const questionType = document.getElementById(`questionType${questionNum}`).value;
                const questionText = document.getElementById(`questionText${questionNum}`).value;
                const questionImageInput = document.getElementById(`questionImage${questionNum}`);
                const questionDiv = questions[index];
                let questionImage = questionDiv.dataset?.image || '';

                if (questionImageInput.files.length > 0) {
                    questionImage = await readImageFile(questionImageInput.files[0]);
                }

                let questionObj = {
                    type: questionType,
                    text: questionText,
                    image: questionImage
                };

                if (questionType === 'multiple-choice') {
                    const answers = [];
                    for (let i = 1; i <= 4; i++) {
                        const answerText = document.getElementById(`answer${questionNum}_${i}`).value;
                        const answerImageInput = document.getElementById(`answerImage${questionNum}_${i}`);
                        let answerImage = '';
                        if (answerImageInput.files.length > 0) {
                            answerImage = await readImageFile(answerImageInput.files[0]);
                        }
                        answers.push(answerText);
                    }
                    const correctAnswer = document.querySelector(`input[name="correctAnswer${questionNum}"]:checked`).value;
                    questionObj.answers = answers;
                    questionObj.correctAnswer = correctAnswer;
                } else if (questionType === 'short-answer') {
                    const correctAnswer = document.getElementById(`correctShortAnswer${questionNum}`).value;
                    questionObj.correctAnswer = correctAnswer;
                } else if (questionType === 'grid-in') {
                    const correctAnswer = document.getElementById(`correctGridInAnswer${questionNum}`).value;
                    questionObj.correctAnswer = correctAnswer;
                }

                testData.sections[section].questions.push(questionObj);
            }

            const testId = editTestId || `${currentType}-${Date.now()}`;
            saveTest(currentType, testData, testId);
            alert('Test saved successfully!');
            editTestId = null;
            window.location.href = `ACT_I_Test_List.html?type=${currentType}`;
        });

        function readImageFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read image'));
                reader.readAsDataURL(file);
            });
        }

        function saveTest(type, testData, testId) {
            const tests = JSON.parse(localStorage.getItem('savedTests')) || {};
            tests[testId] = {
                type: type,
                data: testData,
                createdAt: tests[testId]?.createdAt || new Date().toISOString()
            };
            localStorage.setItem('savedTests', JSON.stringify(tests));
            return testId;
        }

        // Display quiz
        document.getElementById('displayQuizBtn').addEventListener('click', async function () {
            const section1Questions = parseInt(document.getElementById('section1Questions').value);
            const section2Questions = parseInt(document.getElementById('section2Questions').value);
            const questions = document.querySelectorAll('.question-input');

            if (questions.length !== (section1Questions + section2Questions)) {
                alert('Please add the correct number of questions for both sections.');
                return;
            }

            testQuestions = [];
            for (let index = 0; index < questions.length; index++) {
                const questionNum = index + 1;
                const section = questionNum <= section1Questions ? 1 : 2;
                const questionType = document.getElementById(`questionType${questionNum}`).value;
                const questionText = document.getElementById(`questionText${questionNum}`).value;
                const questionImageInput = document.getElementById(`questionImage${questionNum}`);
                const questionDiv = questions[index];
                let questionImage = questionDiv.dataset?.image || '';

                if (questionImageInput.files.length > 0) {
                    questionImage = await readImageFile(questionImageInput.files[0]);
                }

                let questionObj = {
                    type: questionType,
                    text: questionText,
                    image: questionImage,
                    section: section
                };

                if (questionType === 'multiple-choice') {
                    const answers = [];
                    for (let i = 1; i <= 4; i++) {
                        const answerText = document.getElementById(`answer${questionNum}_${i}`).value;
                        const answerImageInput = document.getElementById(`answerImage${questionNum}_${i}`);
                        let answerImage = '';
                        if (answerImageInput.files.length > 0) {
                            answerImage = await readImageFile(answerImageInput.files[0]);
                        }
                        answers.push(answerText);
                    }
                    const correctAnswer = document.querySelector(`input[name="correctAnswer${questionNum}"]:checked`).value;
                    questionObj.answers = answers;
                    questionObj.correctAnswer = correctAnswer;
                } else if (questionType === 'short-answer') {
                    const correctAnswer = document.getElementById(`correctShortAnswer${questionNum}`).value;
                    questionObj.correctAnswer = correctAnswer;
                } else if (questionType === 'grid-in') {
                    const correctAnswer = document.getElementById(`correctGridInAnswer${questionNum}`).value;
                    questionObj.correctAnswer = correctAnswer;
                }

                testQuestions.push(questionObj);
            }

            questionCountSection1 = section1Questions;
            questionCountSection2 = section2Questions;
            section1Duration = parseInt(document.getElementById('section1Duration').value) * 60;
            section2Duration = parseInt(document.getElementById('section2Duration').value) * 60;
            breakDuration = parseInt(document.getElementById('breakDuration').value) * 60;

            currentSection = 1;
            currentQuestionIndex = 0;
            userAnswers = new Array(testQuestions.length).fill(null);

            displayQuiz();
            startSection1Timer();
            document.getElementById('quizBuilder').style.display = 'none';
            document.getElementById('quizDisplaySection').classList.add('active');
        });

        function displayQuiz() {
            const quizQuestionsDiv = document.getElementById('quizQuestions');
            quizQuestionsDiv.innerHTML = '';

            const sectionQuestions = testQuestions.filter(q => q.section === currentSection);
            sectionQuestions.forEach((question, index) => {
                const globalIndex = testQuestions.findIndex(q => q === question);
                const questionDiv = document.createElement('div');
                questionDiv.className = `quiz-question ${index === currentQuestionIndex ? 'active' : ''}`;
                questionDiv.id = `quiz-question-${globalIndex + 1}`;

                let questionHTML = `<h3>Question ${index + 1} (Section ${question.section})</h3><p>${question.text}</p>`;
                if (question.image) {
                    questionHTML += `<div class="image-container"><img src="${question.image}" class="question-image" alt="Question Image"></div>`;
                }

                if (question.type === 'multiple-choice') {
                    questionHTML += '<div class="answer-options-styled">';
                    question.answers.forEach((answer, i) => {
                        questionHTML += `
                            <div class="answer-option-container">
                                <input type="radio" name="answer${globalIndex}" id="answer${globalIndex}_${i}" value="${i + 1}">
                                <label for="answer${globalIndex}_${i}"><span class="option-letter">${String.fromCharCode(65 + i)}.</span>${answer}</label>
                            </div>`;
                    });
                    questionHTML += '</div>';
                } else if (question.type === 'short-answer') {
                    questionHTML += `<input type="text" class="short-answer-input" id="answer${globalIndex}" placeholder="Enter your answer">`;
                } else if (question.type === 'grid-in') {
                    questionHTML += `
                        <div class="grid-in-section">
                            <div class="grid-in-answer-box">
                                <input type="text" class="grid-in-input" id="answer${globalIndex}" placeholder="Enter answer">
                                <div class="grid-in-line"></div>
                            </div>
                        </div>`;
                }

                questionDiv.innerHTML = questionHTML;
                quizQuestionsDiv.appendChild(questionDiv);

                if (question.type !== 'multiple-choice') {
                    const input = questionDiv.querySelector(`#answer${globalIndex}`);
                    input.addEventListener('input', function () {
                        userAnswers[globalIndex] = this.value;
                    });
                } else {
                    questionDiv.querySelectorAll(`input[name="answer${globalIndex}"]`).forEach(radio => {
                        radio.addEventListener('change', function () {
                            userAnswers[globalIndex] = this.value;
                        });
                    });
                }

                if (userAnswers[globalIndex]) {
                    if (question.type === 'multiple-choice') {
                        const radio = questionDiv.querySelector(`#answer${globalIndex}_${userAnswers[globalIndex] - 1}`);
                        if (radio) radio.checked = true;
                    } else {
                        const input = questionDiv.querySelector(`#answer${globalIndex}`);
                        if (input) input.value = userAnswers[globalIndex];
                    }
                }
            });

            updateNavigation();
            document.getElementById('currentSectionTitle').textContent = `Preview Quiz - Section ${currentSection}`;
            document.getElementById('currentSectionTimerLabel').textContent = currentSection;
            MathJax.typesetPromise();
        }

        function updateNavigation() {
            const totalQuestions = currentSection === 1 ? questionCountSection1 : questionCountSection2;
            const adjustedIndex = currentQuestionIndex + 1;

            document.getElementById('currentQuestionNumber').textContent = `Question ${adjustedIndex} of ${totalQuestions}`;
            document.getElementById('prevQuestion').disabled = currentQuestionIndex === 0;
            document.getElementById('nextQuestion').disabled = currentQuestionIndex === totalQuestions - 1;
            document.getElementById('nextQuestion').textContent = currentQuestionIndex === totalQuestions - 1 ? 'Submit Section' : 'Next Question';

            document.getElementById('submitSection1Btn').classList.toggle('hidden', currentSection !== 1 || currentQuestionIndex !== questionCountSection1 - 1);
            document.getElementById('submitSection2Btn').classList.toggle('hidden', currentSection !== 2 || currentQuestionIndex !== questionCountSection2 - 1);
        }

        function startSection1Timer() {
            let timeLeft = section1Duration;
            updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section1Duration);

            section1Timer = setInterval(() => {
                timeLeft--;
                updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section1Duration);

                if (timeLeft <= 0) {
                    clearInterval(section1Timer);
                    submitSection1();
                }
            }, 1000);
        }

        function startSection2Timer() {
            let timeLeft = section2Duration;
            updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section2Duration);

            section2Timer = setInterval(() => {
                timeLeft--;
                updateTimer(timeLeft, 'timerSection1', 'timerProgressBarSection1', section2Duration);

                if (timeLeft <= 0) {
                    clearInterval(section2Timer);
                    submitSection2();
                }
            }, 1000);
        }

        function startBreakTimer() {
            let timeLeft = breakDuration;
            document.getElementById('breakTimer').textContent = formatTime(timeLeft);
            document.getElementById('breakScreen').classList.add('active');

            breakTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('breakTimer').textContent = formatTime(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(breakTimer);
                    document.getElementById('breakScreen').classList.remove('active');
                    currentSection = 2;
                    currentQuestionIndex = 0;
                    displayQuiz();
                    startSection2Timer();
                }
            }, 1000);
        }

        function updateTimer(timeLeft, timerId, progressBarId, totalTime) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById(timerId).textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const percentage = (timeLeft / totalTime) * 100;
            document.getElementById(progressBarId).style.width = `${percentage}%`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        document.getElementById('submitSection1Btn').addEventListener('click', submitSection1);
        document.getElementById('submitSection2Btn').addEventListener('click', submitSection2);

        function submitSection1() {
            clearInterval(section1Timer);
            showResults(1);
            if (breakDuration > 0) {
                startBreakTimer();
            } else {
                currentSection = 2;
                currentQuestionIndex = 0;
                displayQuiz();
                startSection2Timer();
            }
        }

        function submitSection2() {
            clearInterval(section2Timer);
            showResults(2);
        }

        function showResults(section) {
            const resultsSection = document.getElementById(`resultsSection${section}`);
            resultsSection.innerHTML = '';

            let score = 0;
            const sectionQuestions = testQuestions.filter(q => q.section === section);
            sectionQuestions.forEach((question, index) => {
                const globalIndex = testQuestions.findIndex(q => q === question);
                const userAnswer = userAnswers[globalIndex];
                let isCorrect = false;

                if (question.type === 'multiple-choice') {
                    isCorrect = userAnswer === question.correctAnswer;
                } else {
                    isCorrect = userAnswer && userAnswer.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase();
                }

                if (isCorrect) score++;

                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
                resultItem.innerHTML = `
                    <h4>Question ${index + 1} (Section ${section})</h4>
                    <p>${question.text}</p>
                    <div class="answer-comparison">
                        <div class="user-answer">
                            <strong>Your Answer:</strong> ${userAnswer || 'Not answered'}
                        </div>
                        <div class="correct-answer">
                            <strong>Correct Answer:</strong> ${question.type === 'multiple-choice' ? question.answers[parseInt(question.correctAnswer) - 1] : question.correctAnswer}
                        </div>
                    </div>
                    <span class="result-icon">${isCorrect ? '✔' : '✘'}</span>
                `;

                resultsSection.appendChild(resultItem);
            });

            resultsSection.classList.remove('hidden');
            document.getElementById('quizQuestions').style.display = 'none';
            document.getElementById('navigation-buttons').style.display = 'none';
            document.getElementById(`submitSection${section}Btn`).classList.add('hidden');
            document.getElementById('editQuestionsBtn').classList.remove('hidden');

            const summary = document.createElement('div');
            summary.className = 'report-summary';
            summary.innerHTML = `
                <div class="score-card">
                    <div class="score-circle">
                        <span>${score}/${sectionQuestions.length}</span>
                        <span>Section ${section} Score</span>
                    </div>
                </div>
            `;
            resultsSection.insertBefore(summary, resultsSection.firstChild);
        }

        document.getElementById('editQuestionsBtn').addEventListener('click', function () {
            document.getElementById('quizBuilder').style.display = 'block';
            document.getElementById('quizDisplaySection').classList.remove('active');
            document.getElementById('resultsSection1').classList.add('hidden');
            document.getElementById('resultsSection2').classList.add('hidden');
        });

        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        if (type) {
            showQuiz(type);
        }

        // Ensure the initial question's remove button is active
        document.querySelectorAll('.remove-question').forEach(button => {
            button.addEventListener('click', function () {
                const questionId = this.getAttribute('data-question-id');
                const questionElement = document.getElementById(questionId);
                if (questionElement) {
                    questionElement.remove();
                    updateQuestionNumbers();
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93d32824bd89bcc5',t:'MTc0NjgxNDI2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const qTypeSelect = document.getElementById('questionType1');
    if (qTypeSelect) {
        qTypeSelect.addEventListener('change', function () {
            const type = this.value;
            const answerOptions = document.getElementById('answerOptions1');
            const shortAnswerOptions = document.getElementById('shortAnswerOptions1');
            const gridInOptions = document.getElementById('gridInOptions1');

            answerOptions.classList.add('hidden');
            shortAnswerOptions.classList.add('hidden');
            gridInOptions.classList.add('hidden');

            if (type === 'multiple-choice') {
                answerOptions.classList.remove('hidden');
            } else if (type === 'short-answer') {
                shortAnswerOptions.classList.remove('hidden');
            } else if (type === 'grid-in') {
                gridInOptions.classList.remove('hidden');
            }
        });
    }
});
</script>

</body>
</html>